---
title: "National Climatic Data Center Storm Events Analysis"
output: 
  html_document:
    keep_md: true
    toc: true
    toc_float: true
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

Storms and other severe weather events can cause both public health and economic problems for communities and municipalities. Many severe events can result in fatalities, injuries, and property damage, and preventing such outcomes to the extent possible is a key concern.

This project involves exploring the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.

## Data 

The data for this assignment come in the form of a comma-separated-value file compressed via the bzip2 algorithm to reduce its size. You can download the file from the course web site:

* [Storm Data](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2)

There is also some documentation of the database available. Here you will find how some of the variables are constructed/defined.

* National Weather Service [Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf)
* National Climatic Data Center Storm Events [FAQ](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf)

## Environment Setup

```{r Library and Setup, message=FALSE}
library(tidyverse)
library(plotly)
library(tidytext)
library(dygraphs)
library(cowplot)
library(lubridate)
library(stringi)
downloadDate <- date()
sessionInfo()
```

## Data Processing

Download date is `r downloadDate`.
```{r Load Data, message=FALSE, cache=TRUE}
fileUrl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
fname <- c("./data/maindf.csv.bz2")

if(!file.exists("data")){
        dir.create("data")
}

download.file(fileUrl,destfile="./data/maindf.csv.bz2",method="curl")

maindf <- read.csv(fname, header = TRUE, na.strings=c("","NA"), stringsAsFactors = FALSE)
```


```{r, cache=TRUE}
df <- maindf
str(df)
```

## Purpose

The basic goal of this assignment is to explore the NOAA Storm Database and answer some basic questions about severe weather events. You must use the database to answer the questions below and show the code for your entire analysis. Your analysis can consist of tables, figures, or other summaries. You may use any R package you want to support your analysis.

Data analysis must address the following questions:

1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

2. Across the United States, which types of events have the greatest economic consequences?

## Strategy in Dimension Reduction

1. Focus on the **Purpose**
2. Analyze missing data
    + Event Type
    + Harmful to health 
    + Economic consequences 
3. Analyze Date and time

### Missing Data Analysis

```{r Date and Time}
## We will analyze the beginning date only ----
df$BGN_DATE <- as.POSIXct(df$BGN_DATE,format="%m/%d/%Y")
df$END_DATE <- as.POSIXct(df$END_DATE,format="%m/%d/%Y")

startDate <- min(df$BGN_DATE)
endDate <- max(df$BGN_DATE)

```
Date range from **`r startDate`**, **`r endDate` 

```{r Missing Data Analysis}
naAnalysis <- df %>%
    purrr::map_df(function(x) round(mean(is.na(x)),digits = 2)*100) %>%
    gather(EVType, naAverage) %>% 
    print(n = 10)

naAnalysis1 <- naAnalysis %>% arrange(naAverage) %>% filter(naAverage>0)
quantile(naAnalysis1$naAverage) # range 16 100
```


```{r Missing_Data_plot g1}
g1 <-
  naAnalysis %>% ggplot(aes(x = EVType, y = naAverage)) %>% +
  geom_point(aes(reorder(EVType, naAverage))) + theme(axis.text.x =
              element_text(angle = 90, hjust = .1)) + labs(x = "Event Type", 
              y = "NA Average (%)", title = "Missing Data Analysis")

gg1 <-
  naAnalysis1 %>% ggplot(aes(x = EVType, y = naAverage)) %>% +
  geom_point(aes(reorder(EVType, naAverage))) + theme(axis.text.x =
              element_text(angle = 90, hjust = .1)) + 
              labs(x = "Event Type", y = "NA Average (%)", 
                   title = "Missing Data Analysis")

ggg1 <-
  subplot(g1, gg1, shareY = TRUE, nrows = 1) %>% layout(autosize = T)
ggg1
```
The above chart shows the original 37 variables, 23 variables has 0 missing data and 14 variables with missing data. Base on our **Purpose**, we need to look at Harmful (FATALITIES, INJURIES) - 0 missing data, EVTYPE has 0missing data and Property/Crop damages missing data.  EVTYPE has 0 missing data.  

Property damages are divided into 2 variables which are:

1. PROPDMG - 0 missing data
2. PROPDMGEXP (unit of measure) - 52 % missing data 

Crop damages are divided into 2 variables which are

1. CROPDMG - 0 missing data
2. CROPDMGEXP (unit of measure) - 69 % missing data

Next step is to dig deeper and see what is behind our 52% missing data in PROPDMGEXP and 69% missing data in CROPDMGEXP. 

### PROPDMGEXP Unit of Measure Analysis

According to [Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf) (page 12) the magnitude of the PROPDMG and CROPDMG are as follows: K= 10^3, M= 10^6, B=10^9

```{r range of PROPDMGEXP g2}
RgPropEXP <- table(unlist(df$PROPDMGEXP))
RgPropEXPdf <-
  tibble(Unit = names(RgPropEXP), FREQ = as.integer(RgPropEXP))
```
### CROPDMGEXP Unit of Measure Analysis

```{r range of CROPDMGEXP g2}
RgCropEXP <- table(unlist(df$CROPDMGEXP))
RgCropEXPdf <- tibble(Unit = names(RgCropEXP), FREQ = as.integer(RgCropEXP))
```

PROPDMGEXP and CROPDMGEXP should only have K = 10^3, M = 10^6, B = 10^9 as their magnitude.  The chart below tells us the magnitude of measure has more than 3.  

Our next step is to combine the missing data of PROPDMGEXP and CROPDMGEXP with PROPDMG and CROPDMG respectively.  
```{r combined}
RgCropEXPdf$Event <- "Crop"
RgPropEXPdf$Event <- "Prop"
PC<-rbind(RgPropEXPdf,RgCropEXPdf)
ggplotly(PC %>% ggplot(aes(x=(Unit), y=FREQ, fill=Event)) +geom_col() +scale_y_log10() + labs(x= "Magnitude of Measure (K, M, B)", y= "Frequency", title= "Frequency of Magnitude of Measure"))
```

### Property Damage with Missing Unit of Measure Analysis

```{r PROPDMGEXP NA g3, results='hide'}
PropDmgDF <- df %>% filter(is.na(PROPDMGEXP), PROPDMG > 0)

g3 <-
  PropDmgDF %>% group_by(
    Y = year(BGN_DATE),
    MONTH = month(BGN_DATE,
                  label = TRUE, abbr = TRUE),
    STATE,
    EVTYPE
  ) %>%
  summarize(PROPDMG = sum(PROPDMG)) %>% arrange(STATE) ## analysis by month ----

gg3 <-
  g3 %>% ggplot(aes(x = MONTH, y = (PROPDMG))) + geom_col(aes(fill = EVTYPE)) + 
  facet_wrap(g3$Y) + labs(x = "Month", y = "Total Property Damage (missing units)",
       title = "Total Property Damage (missing units) by Month") +
  theme(axis.text.x = element_text(angle = 90, hjust = .5))

ggg3 <-
  g3 %>% ggplot(aes(x = STATE, y = (PROPDMG))) + geom_col(aes(fill = factor(g3$Y)) + 
  labs(x = "State", y = "Total Property Damage (missing units)", 
       title = "Total Property (missing units) by State") +
  theme(axis.text.x = element_text(angle = 90, hjust = .5))
```

```{r column chart missing unit}
psum<-sum(PropDmgDF$PROPDMG)
plen<-length(PropDmgDF$PROPDMG)
ggplotly(gg3) %>% layout(autosize =T)
```
We can see that the when PROPDMGEXP is combined with PROPDMG there are `r plen` observations valuing `r psum`. The above chart tells they are spread in years 1993, 1994, and 1995. All three years ca an


```{r Missing units Poperty by State}
ggplotly(ggg3)
```
### Crop Damages Missing Unit of Measure Analysis

```{r CROPDMGEXP g4, results='hide'}
CropDmgDF <- df %>% filter(is.na(CROPDMGEXP), CROPDMG > 0)

g4 <-
  CropDmgDF %>% group_by(
    Y = year(BGN_DATE),
    MONTH = month(BGN_DATE,
                  label = TRUE, abbr = TRUE),
    STATE,
    EVTYPE
  ) %>%
  summarize(CROPDMG = sum(CROPDMG)) %>% arrange(STATE) ## analysis by month ----

gg4 <-
  g4 %>% ggplot(aes(x = MONTH, y = (CROPDMG))) + geom_col(aes(fill = EVTYPE)) + 
  facet_wrap(g4$Y) + labs(x = "Month", y = "Total Crop Damange (missing units)",
       title = "Total Crop Damage (missing units) by Month") +
  theme(axis.text.x = element_text(angle = 90, hjust = .5))

ggg4 <-
  g4 %>% ggplot(aes(x = STATE, y = (CROPDMG))) + geom_col(aes(fill = EVTYPE)) + 
  labs(x = "State", y = "Total Crop Damange (missing units)", 
       title = "Total Crop (missing units) by State") +
  theme(axis.text.x = element_text(angle = 90, hjust = .5))
```

```{r}
ggplotly(gg4)
```

```{r}
ggplotly(ggg4)
```

### Findings and Recommendations

According to [Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf) (page 12) the magnitude of the PROPDMG and CROPDMG are as follows: K= 10^3, M= 10^6, B=10^9

Property Damage with missing magnitude **Findings**:

1. PROPDMGEXP has 18 unique observations, K has the most frequency
2. PROPDMGEXP  has 52% missing data
3. Out of the 52% missing data there are 76 observations for property damage valuing more than 0.
4. These occurrences happened during 1993,1994, 1995
5. 15 States are affected with a total property damage of 527.41 without any unit of measurement.  

PROPDMGEXP **Recommendation**:

1. Use the magnitude recommended by the Storm Data Documentation (K, M, B) plus O =10^0
2. Data base manager needs to address this issue and convert CROPDMGEXP to O=10^0, K= 10^3, M= 10^6, and B=10^9.
3. Person that completes the data entry should only have a choice of O, K, M, B, as a unit of measure

Crop Damage with missing magnitude **Findings**:

1. CROPDMGEXP has 8 unique observations
2. CROPDMGEXP has 69% missing data
3. Out of the 69% missing data there are 3 observations for crop damage valuing more than 0.
4. These occurrences happened in April **and** July of 1994
5. Two states are affected North Dakota, and Texas with a total amount of 11 without any unit of measurement.


CROPDMGEXP **Recommendation**:

1. Use the magnitude recommended by the Storm Data Documentation (K, M, B) plus O =10^0
2. Data base manager needs to address this issue and convert CROPDMGEXP to O=10^0, K= 10^3, M= 10^6, and B=10^9.
3. Person that completes the data entry should only have a choice of O, K, M, B, as a unit of measure

### Event Type Analysis

According to [Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf) there are 48 Event Types.  They are listed on page 2 of the table of contents listed as 7.1 to 7.48. 

```{r}
RgEventType <- table(unlist(df$EVTYPE))
RgEvenTypeDf <-
  tibble(Event = names(RgEventType), FREQ = as.integer(RgEventType))
print(RgEvenTypeDf, nrow = 1:20) 

g5<- RgEvenTypeDf %>% arrange(desc(RgEvenTypeDf$FREQ)) %>% select(Event, FREQ) %>% print(n=20)

```

```{r}
g5
```








```{r Strategy}
greatflood <- df %>% group_by(Y=year(BGN_DATE), BGN_DATE) %>% filter(Y=="1993") %>% summarize(PropDmg = sum(PROPDMG)) ## total property dmg is 19 but at what unit
```



Subset the data that answers the purpose. 

```{r filtered dataset}
Fstdata <- df %>% group_by(YEAR= year(BGN_DATE), STATE, EVTYPE) %>% summarize(fatTotal = sum(FATALITIES), injTotal =sum(INJURIES), Dmg =sum(PROPDMG+CROPDMG)) %>% arrange(STATE)

library(plotluck)
plotluck(Fstdata, fatTotal~propDMG|EVTYPE)

plotluck(Fstdata, injTotal~Y|EVTYPE)
plotluck(Fstdata, Dmg~Year|EVTYPE)


ggplot(data = Fstdata, aes(x=EVTYPE, y=Dmg, alpha=.02))+ geom_point()+geom_abline(fit1)


fit1 <- lm(data = Fstdata, formula = Dmg~EVTYPE)
plot(fit1)
```
### Examine the data as follows:

1. Fatality by year and state
2. Injuries by year and state
3. Property Damage by year and state
4. Crop damage by year and state
5. 1+2
6. 3+4
7. Month 

#### Fatality by Year

The column chart below shows the intensity of fatalities change from 1950-1992 to 1993-2011 . 

```{r FatalityByYear}
# examine fatality by year
g3 <-
        Fstdata %>% ggplot(aes(x = YEAR, y = (fatTotal))) + geom_col(aes(fill =
                STATE)) +geom_hline(yintercept = 100) + geom_vline(xintercept = 1993)+ labs(x = "Year", y = "Total Fatality", title = "Total Fatality by Year")
ggplotly(g3)
```
#### Fatality by State

Filtered out fatalities less than 0. Column chart shows 10 states with fatalities more than 500.  

```{r FatalityByState}
g4 <-
        Fstdata %>% filter(fatTotal>0) %>%  ggplot(aes(x = STATE, y = (fatTotal))) + geom_col(aes(fill=EVTYPE)) + geom_hline(yintercept = 500) + labs(x = "State", y = "Total Fatality", title = "Total Fatality by State")+theme(axis.text.x=element_text(angle=90,hjust=.5))
ggplotly(g4)
```

#### Property Damage by Year

Review missing data in PROPDMGEXP and remove any PROPDMG less than 0. We see 76 observations which ranges 15 states and total PROPDMG of 527.41 without a proper unit of measure.  All within 1993, 1994 and 1995.  






